--- rc.lua	2015-09-09 23:11:13.106206730 +0200
+++ rc-test.lua	2015-09-09 23:30:16.104075583 +0200
@@ -12,7 +12,9 @@
 local menubar = require("menubar")
 -- Redshift integration
 local redshift = require("redshift")
-local aweror = require("aweror")
+-- Run or raise
+local ror = require("aweror")
+
 
 -- {{{ Functions
 function run_once(cmd)
@@ -24,22 +26,59 @@
   awful.util.spawn_with_shell("pgrep -u $USER -x " .. findme .. " > /dev/null || (" .. cmd .. ")")
 end
 
-function run_or_raise(cmd)
-    -- Check throught the clients if the class match the cmd
-    local lower_cmd=string.lower(cmd)
-    for k, c in pairs(client.get()) do
-        local class=string.lower(c.class)
-        if string.match(class, lower_cmd) then
-            for i, v in ipairs(c:tags()) do
-                awful.tag.viewonly(v)
-                c:raise()
-                c.minimized = false
-                return
-            end
-        end
-    end
-    run_once(cmd)
+--- Spawns cmd if no client can be found matching properties
+-- If such a client can be found, pop to first tag where it is visible, and give it focus
+-- @param cmd the command to execute
+-- @param properties a table of properties to match against clients.  Possible entries: any properties of the client object
+function run_or_raise(cmd, properties)
+   local clients = client.get()
+   local focused = awful.client.next(0)
+   local findex = 0
+   local matched_clients = {}
+   local n = 0
+   for i, c in pairs(clients) do
+      --make an array of matched clients
+      if match(properties, c) then
+         n = n + 1
+         matched_clients[n] = c
+         if c == focused then
+            findex = n
+         end
+      end
+   end
+   if n > 0 then
+      local c = matched_clients[1]
+      -- if the focused window matched switch focus to next in list
+      if 0 < findex and findex < n then
+         c = matched_clients[findex+1]
+      end
+      local ctags = c:tags()
+      if #ctags == 0 then
+         -- ctags is empty, show client on current tag
+         local curtag = awful.tag.selected()
+         awful.client.movetotag(curtag, c)
+      else
+         -- Otherwise, pop to first tag client is visible on
+         awful.tag.viewonly(ctags[1])
+      end
+      -- And then focus the client
+      client.focus = c
+      c:raise()
+      return
+   end
+   awful.util.spawn(cmd)
 end
+
+-- Returns true if all pairs in table1 are present in table2
+function match (table1, table2)
+   for k, v in pairs(table1) do
+      if table2[k] ~= v and not table2[k]:find(v) then
+         return false
+      end
+   end
+   return true
+end
+
 -- }}}
 
 
@@ -292,7 +331,7 @@
 
     awful.key({ modkey, "Control" }, "n", awful.client.restore),
 
-    awful.key({ modkey },            "n",     run_or_raise(browser)),
+    awful.key({ modkey },            "n",     function ()  run_or_raise('firefox', { class = "Firefox" }) end),
 
     -- dmenu
     -- Run or raise applications with dmenu
